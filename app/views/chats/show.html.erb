  <div class="chat-container">

    <header class="back-button return_to">
      <i class="fas fa-arrow-left"></i>
      <%= link_to "Back to Movie Search", chats_path %>
    </header>

    <div class="chat-header">
      <h1><%= @chat.title %></h1>
    </div>

    <div>
      <%= link_to "Delete this watchlist", chat_path,
      data: { turbo_method: :delete, turbo_confirm: "do you want to delete this watchlist ?" },
      class: "btn btn-outline-danger delete_button" %>
    </div>

    <!-- 1ï¸âƒ£ Movie suggestions -->
    <% if @movies.any? %>
      <h5 class="card-title fw-bold mb-4">Saved in your List</h5>
      <div class="movie-suggestions mb-5">
        <% @movies.each do |movie| %>
          <div class="watchlist_container_chat_index">
            <% if movie.img_url.present? %>
              <%= image_tag movie.img_url, alt: movie.title %>
            <% else %>
              <div style="height: 250px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">
                ðŸŽ¬
              </div>
            <% end %>
            <h5><%= movie.title %></h5>
            <p><%= movie.description %></p>
            <%= link_to "See movie details", movie_path(movie), class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- 2ï¸âƒ£ Chat section (horizontal under movie suggestions) -->
    <h5 class="card-title fw-bold mb-4">Keep discussing with your movie assistant to get other suggestions</h5>
      <div class="chat_body mb-4">
        <div class="chat_section">
          <div class="chat_container mt-4 p-3">

          <% @messages.each do |message| %>
            <% if message.role == "assistant" %>
              <div class="d-flex mb-3">
                <div class="assistant_messages">
                  <%# Check for JSON with movie recommendations %>
                  <% json_match = message.content.match(/\[.*\]/m) %>
                  <% if json_match %>
                    <% begin %>
                      <% movies_data = JSON.parse(json_match[0]) %>
                      <% if movies_data.is_a?(Array) && movies_data.any? %>
                        <p class="mb-2"><strong>We think you may like these movies:</strong></p>
                        <ul class="movie-recommendations">
                          <% movies_data.each do |m| %>
                            <li class="movie-card">
                              <% if m['image_url'].present? && m['image_url'] != 'N/A' %>
                                <%= image_tag m['image_url'], alt: m['title'] %>
                              <% end %>
                              <div class="movie-info">
                                <strong><%= m['title'] %></strong>
                                <small>(<%= m['year'] %>)</small>
                                <ul>
                                  <li><%= m['description'] %></li>
                                </ul>
                              </div>
                              <%= button_to "Save to My List",
                                chat_recommendations_path(@chat),
                                method: :post,
                                params: { movie_data: m.to_json },
                                class: "btn" %>
                            </li>
                          <% end %>
                        </ul>
                      <% else %>
                        <div style="white-space: pre-wrap; line-height: 1.3;"><%= message.content.strip %></div>
                      <% end %>
                    <% rescue JSON::ParserError %>
                      <div style="white-space: pre-wrap; line-height: 1.3;"><%= message.content.strip %></div>
                    <% end %>
                  <% else %>
                    <div style="white-space: pre-wrap; line-height: 1.3;"><%= message.content.strip %></div>
                  <% end %>
                </div>
              </div>
            <% else %>
              <div class="d-flex justify-content-end mb-3">
                <div class="bg-primary chat_user_message">
                  <%= message.content.strip %>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>

        <div class="chat-input-container">
          <%= form_with model: [@chat, Message.new], url: chat_messages_path(@chat), class: "d-flex" do |f| %>
            <%= f.text_field :content,
              class: "chat-input",
              placeholder: "Type your message...",
              autocomplete: "off" %>
            <%= f.button type: "submit", class: "chat-send-button" do %>
              <i class="fas fa-paper-plane"></i> <!-- ou le contenu de votre bouton -->
            <% end %>
          <% end %>
        </div>
        </div>
      </div>
    </div>
</div>
</div>
