<div class="container my-5" style="max-width: 1200px; margin: 0 auto;">
  <h1 class="form-title">Find Your Next Movie üé¨</h1>

  <header class="show-header mb-4 return_to">
    <%= link_to "‚¨ÖÔ∏è Back to Movie Search", chats_path %>
  </header>

  <div class="my-2 chat_name_in_watchlist">
    <h3 class="mb-1">Chat: <i>"<%= @chat.mood %>"</i></h3>
  </div>

  <!-- 1Ô∏è‚É£ Movie suggestions -->
  <div class="movie-suggestions mb-5">
    <% @movies.each do |movie| %>
      <div class="watchlist_container_chat_index">
        <% if movie.img_url.present? %>
          <%= image_tag movie.img_url, alt: movie.title %>
        <% else %>
          <div style="height: 250px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">
            üé¨
          </div>
        <% end %>
        <h5><%= movie.title %></h5>
        <p><%= movie.description %></p>
        <%= link_to "See movie details", movie_path(movie), class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>

  <!-- 2Ô∏è‚É£ Chat section (horizontal under movie suggestions) -->
  <div class="chat_section">
    <div class="chat_container mt-4 p-3">
      <h5 class="card-title fw-bold mb-4" style="font-size: 1.25rem;">Keep discussing with your movie assistant üçø</h5>
      <div class="chat_body mb-4">
        <% @messages.each do |message| %>
          <% if message.role == "assistant" %>
            <div class="d-flex mb-3">
              <div class="bg-light assistant_messages">
                <%# Check for JSON with movie recommendations %>
                <% json_match = message.content.match(/\[.*\]/m) %>
                <% if json_match %>
                  <% begin %>
                    <% movies_data = JSON.parse(json_match[0]) %>
                    <% if movies_data.is_a?(Array) && movies_data.any? %>
                      <p class="mb-2"><strong>Assistant recommends:</strong></p>
                      <ul class="movie-recommendations">
                        <% movies_data.each do |m| %>
                          <li class="movie-card">
                            <% if m['image_url'].present? && m['image_url'] != 'N/A' %>
                              <%= image_tag m['image_url'], alt: m['title'] %>
                            <% end %>
                            <strong><%= m['title'] %></strong>
                            <small>(<%= m['year'] %>)</small>
                            <ul>
                              <li><strong>Description:</strong> <%= m['description'] %></li>
                            </ul>
                            <%= button_to "Save this movie",
                                  chat_recommendations_path(@chat),
                                  method: :post,
                                  params: { movie_data: m.to_json },
                                  class: "btn btn-success btn-sm mt-auto" %>
                          </li>
                        <% end %>
                      </ul>
                    <% else %>
                      <div style="white-space: pre-wrap; line-height: 1.3;"><%= message.content.strip %></div>
                    <% end %>
                  <% rescue JSON::ParserError %>
                    <div style="white-space: pre-wrap; line-height: 1.3;"><%= message.content.strip %></div>
                  <% end %>
                <% else %>
                  <div style="white-space: pre-wrap; line-height: 1.3;"><%= message.content.strip %></div>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="d-flex justify-content-end mb-3">
              <div class="bg-primary chat_user_message">
                <%= message.content.strip %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>

      <%= form_with model: [@chat, Message.new], url: chat_messages_path(@chat), class: "d-flex" do |f| %>
        <%= f.text_field :content, class: "form-control", style: "border-radius: 6px 0 0 6px; border-right: none; background: white;", placeholder: "Type your message..." %>
        <%= f.submit "Send", class: "btn btn-primary", style: "border-radius: 0 6px 6px 0;" %>
      <% end %>
    </div>
  </div>
</div>
