<!-- VERSION FINALE AVEC FIX DU BACKDROP -->
<div class="chat-container">

    <!-- MODALE POUR LES DÃ‰TAILS DU FILM -->
    <div class="modal fade" id="movieModal" tabindex="-1">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header border-secondary">
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="movieModalContent">
            <div class="text-center py-5">
              <div class="spinner-border text-danger" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <header class="back-button return_to">
      <i class="fas fa-arrow-left"></i>
      <%= link_to "Back to Movie Search", chats_path %>
    </header>

    <div class="chat-header">
      <h1><%= @chat.title %></h1>
    </div>

    <div>
      <%= link_to "Delete this search", chat_path,
      data: { turbo_method: :delete, turbo_confirm: "do you want to delete this watchlist ?" },
      class: "btn btn-outline-danger delete_button" %>
    </div>

    <!-- 1ï¸âƒ£ Movie suggestions -->
    <% if @recommendations.any? %>
      <h5 class="card-title fw-bold mb-4">Saved in your List</h5>
      <div class="movie-suggestions mb-5">
        <% @recommendations.each do |recommendation| %>
          <div class="watchlist_container_chat_index">
            <% if recommendation.movie.img_url.present? %>
            <div class="movie-img" style="background-image: url(<%=recommendation.movie.img_url%>)">
              <%= link_to  chat_recommendation_path(@chat, recommendation),
              data: { turbo_method: :delete, turbo_confirm: "do you want to delete this watchlist ?" } do %>
                <i class="fa-solid fa-trash"></i>
              <% end %>
            </div>
            <% else %>
              <div style="height: 250px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">
                ðŸŽ¬
              </div>
            <% end %>
            <h5><%= recommendation.movie.title %></h5>
            <p><%= recommendation.movie.description %></p>

            <!-- BOUTON POUR OUVRIR LA MODALE -->
            <button
              class="btn btn-primary movie-detail-btn"
              data-movie-id="<%= recommendation.movie.id %>"
              type="button">
              See movie details
            </button>

           </div>
        <% end %>
      </div>
    <% end %>

    <!-- 2ï¸âƒ£ Chat section -->
    <h5 class="card-title fw-bold mb-4">Keep discussing with your movie assistant to get other suggestions</h5>
      <div class="chat_body mb-4">
        <div class="chat_section">
          <div id="messages" class="chat_container mt-4 p-3">
            <%= render "chats/messages", messages: @chat.messages %>
          </div>

        <div id="chat-input" class="chat-input-container">
          <%= render "chats/form", chat: @chat, message: @message %>
        </div>
        </div>
      </div>
    </div>
</div>

<!-- JAVASCRIPT FINAL AVEC FIX DU BACKDROP -->
<script>
  console.log("ðŸŽ¬ Movie modal script loaded!");

  let currentModal = null;

  function loadMovieDetails(movieId) {
    console.log("Loading movie ID:", movieId);

    const modalElement = document.getElementById('movieModal');
    const modalContent = document.getElementById('movieModalContent');

    // Afficher le spinner
    modalContent.innerHTML = `
      <div class="text-center py-5">
        <div class="spinner-border text-danger" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    `;

    // CrÃ©er et ouvrir la modale
    currentModal = new bootstrap.Modal(modalElement);
    currentModal.show();

    // Charger les donnÃ©es via AJAX
    fetch(`/movies/${movieId}`, {
      headers: {
        'Accept': 'text/javascript',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => {
      console.log("Response status:", response.status);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.text();
    })
    .then(script => {
      console.log("Script received, executing...");
      eval(script);
    })
    .catch(error => {
      console.error('Error loading movie:', error);
      modalContent.innerHTML = `
        <div class="alert alert-danger">
          <h4>Error loading movie details</h4>
          <p>${error.message}</p>
        </div>
      `;
    });
  }

  // âœ… FIX DU BACKDROP - Nettoyer quand la modale se ferme
  function cleanupModal() {
    // Supprimer tous les backdrops
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
      backdrop.remove();
    });

    // RÃ©activer le scroll du body
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
  }

  // Setup event listeners
  function setupMovieButtons() {
    const buttons = document.querySelectorAll('.movie-detail-btn');
    console.log("Found movie buttons:", buttons.length);

    buttons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        const movieId = this.dataset.movieId;
        loadMovieDetails(movieId);
      });
    });

    // âœ… Ã‰couter l'Ã©vÃ©nement de fermeture de la modale
    const modalElement = document.getElementById('movieModal');
    if (modalElement) {
      modalElement.addEventListener('hidden.bs.modal', function () {
        console.log("Modal closed, cleaning up...");
        cleanupModal();
      });
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', setupMovieButtons);
  document.addEventListener('turbo:load', setupMovieButtons);

  // âœ… Cleanup avant de quitter la page
  window.addEventListener('beforeunload', cleanupModal);
</script>
