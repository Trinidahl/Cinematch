<div class="container my-5" style="max-width: 900px; margin: 0 auto;">
  <h1 class="form-title">Find Your Next Movie üé¨</h1>

  <header class="show-header mb-4">
    <%= link_to "‚¨ÖÔ∏è Back to Movie Search", chats_path %>
  </header>

  <div class="container my-2">
    <h3 class="mb-1">Chat: <i>"<%= @chat.mood %>"</i></h3>

    <% if @movies.any? %>
      <div class="row">
        <% @movies.each do |movie| %>
          <div class="col-md-4 mb-4">
            <div class="card" style="max-width: 18rem;">
              <%= image_tag "dark-night.jpg", class: "card-img-top", alt: "image of the movie", style: "height: 250px; object-fit: contain;" %>
              <div class="card-body">
                <h5 class="card-title"><%= movie.title %></h5>
                <p class="card-text"><%= movie.description %></p>
                <%= link_to "See movie details", movie_path(movie), class: "btn btn-primary" %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Chat moderne avec historique -->
  <div class="mt-4 p-3" style="background: white; max-width: 900px; margin: auto; box-shadow: 0 2px 8px rgba(108, 107, 107, 0.1); border-radius:8px">
    <h5 class="card-title fw-bold mb-4" style="font-size: 1.25rem;">Keep discussing with your movie assistant to get better suggestions üçø</h5>

    <!-- Historique des messages -->
    <div class="mb-4" style="max-height: 500px; overflow-y: auto; background: white">
      <% @messages.each do |message| %>

        <%# Message de l'assistant %>
        <% if message.role == "assistant" %>
          <div class="d-flex mb-3">
            <div class="bg-light" style="max-width: 80%; padding: 12px; border-radius: 8px; font-size: 1rem">

              <%
                # Essayer de trouver du JSON dans le message
                json_match = message.content.match(/\[.*\]/m)

                if json_match
                  # Parser le JSON
                  begin
                    movies_data = JSON.parse(json_match[0])

                    # Si c'est un tableau de films, afficher avec placeholders
                    if movies_data.is_a?(Array) && movies_data.any?
              %>
                      <p class="mb-2"><strong>Here are some movie recommendations:</strong></p>
                      <ul style="list-style-type: disc; padding-left: 20px;">
                        <% movies_data.each do |movie| %>
                          <li class="mb-3">

                            <!-- Placeholder avant d'avoir l'image du film  -->
                            <div class="mb-2" style="width: 150px; height: 225px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; text-align: center; padding: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                              <div>
                                <div style="font-size: 2rem; margin-bottom: 10px;">üé¨</div>
                                <div style="color: white; font-weight: 600; font-size: 0.9rem; line-height: 1.2;">
                                  <%= truncate(movie['title'], length: 30) %>
                                </div>
                                <div style="color: rgba(255,255,255,0.8); font-size: 0.75rem; margin-top: 5px;">
                                  <%= movie['year'] %>
                                </div>
                              </div>
                            </div>

                            <!-- Infos du film √† placer dans la future vignette -->
                            <strong><%= movie['title'] %></strong> (<%= movie['year'] %>)
                            <ul style="list-style-type: circle; padding-left: 20px; margin-top: 5px;">
                              <li><strong>Director:</strong> <%= movie['director'] %></li>
                              <li><strong>Genre:</strong> <%= movie['genre'] %></li>
                              <li><strong>Country:</strong> <%= movie['country'] %></li>
                              <li><strong>Description:</strong> <%= movie['description'] %></li>
                            </ul>
                            <%= button_to "Save this movie",
                                          chat_recommendations_path(@chat),
                                          method: :post,
                                          # movie_data est un hash donc il faut le transformer en string json
                                          params: { movie_data: movie.to_json },
                                          class: "btn btn-success btn-sm mt-2" %>
                            <% end %>
                      </ul>
              <%
                    else
                      # Si ce n'est pas un tableau, afficher le message normal
              %>
                      <div style="white-space: pre-wrap; line-height: 1.3;">
                        <%= message.content.strip %>
                      </div>
              <%
                    end
                  rescue JSON::ParserError
                    # Si erreur de parsing, afficher le message normal
              %>
                    <div style="white-space: pre-wrap; line-height: 1.3;">
                      <%= message.content.strip %>
                    </div>
              <%
                  end
                else
                  # Pas de JSON trouv√©, afficher le message normal
              %>
                  <div style="white-space: pre-wrap; line-height: 1.3;">
                    <%= message.content.strip %>
                  </div>
              <%
                end
              %>

            </div>
          </div>

        <%# Message de l'utilisateur %>
        <% else %>
          <div class="d-flex justify-content-end mb-3">
            <div class="bg-primary text-white" style="max-width: 80%; white-space: pre-wrap; line-height: 1.3; padding: 12px; border-radius: 8px; font-size: 1rem;">
              <%= message.content.strip %>
            </div>
          </div>
        <% end %>

      <% end %>
    </div>

    <!-- Champ de saisie et bouton -->
    <%= form_with model: [@chat, Message.new], url: chat_messages_path(@chat), class: "d-flex" do |f| %>
      <%= f.text_field :content, class: "form-control", style: "border-radius: 6px 0 0 6px; border-right: none; background: white;", placeholder: "Type your message..." %>
      <%= f.submit "Send", class: "btn btn-primary", style: "border-radius: 0 6px 6px 0;" %>
    <% end %>
  </div>
</div>
